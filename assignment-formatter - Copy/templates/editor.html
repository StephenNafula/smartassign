<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assignment Editor</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    /* container split */
    .container { display:flex; gap:20px; height: calc(100vh - 70px); padding:20px; box-sizing:border-box; }
    .editor-pane, .preview-pane { flex:1; overflow:auto; }
    .preview-wrapper { display:flex; justify-content:center; align-items:flex-start; padding:20px; }
    /* actual "page" style */
    .page {
      width: 794px; /* 8.27in at 96dpi ~ A4 landscape; choose appropriate width; feel free to use 595px for A4 72dpi */
      max-width: 100%;
      background: white;
      border: 1px solid #e6e6e6;
      box-shadow: 0 8px 20px rgba(2,6,23,0.08);
      padding: 1in; /* default page margin will be overridden by APA/MLA functions */
      box-sizing: border-box;
      font-family: "Times New Roman", serif;
      color: #111827;
    }
    /* The content inside page will use the academic styles */
    .page .content { font-size: 12pt; line-height: 1.5; }
    /* helper for narrow/normal */
    .margin-narrow { padding: 0.5in !important; }
    .margin-normal { padding: 1in !important; }
    /* APA/MLA specific visual tweaks (we apply these via JS) */
  </style>
</head>
<body>
  <header style="background:#0052cc;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center;">
    <h2>Assignment Editor</h2>
    <a href="/logout" class="btn">Logout</a>
  </header>

  {% if user_plan_info %}
  <div style="background: #f0f8ff; padding: 10px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em;">
      <span>Current Plan: <strong>{{ user_plan_info.plan_name }}</strong></span>
      {% if user_plan_info.plan_type == 'one_time_document' %}
      <span>Credits Remaining: <strong>{{ user_plan_info.document_credits }}</strong></span>
      {% elif user_plan_info.plan_type == 'monthly_subscription' %}
      <span>Subscription ends: <strong>{{ user_plan_info.subscription_end_date.strftime('%Y-%m-%d') if user_plan_info.subscription_end_date else 'N/A' }}</strong></span>
      {% endif %}
      <a href="{{ url_for('plans') }}" style="color: #0052cc; text-decoration: none;">Upgrade Plan</a>
  </div>
  {% endif %}

  <div class="container">
    <!-- Left Side: Rich Text Editor -->
    <div class="editor-pane">
      <div id="toolbar" class="toolbar">
        <select class="ql-header">
          <option selected></option>
          <option value="1">Heading 1</option>
          <option value="2">Heading 2</option>
        </select>
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-underline"></button>
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
        <button class="ql-link"></button>
        <button class="ql-clean"></button>
      </div>

      <div id="editor" style="height:60vh; background:#fff;"></div>

      <div style="margin-top:12px">
        <select id="citationStyle">
          <option value="">-- Choose style (Preview) --</option>
          <option value="apa">APA (6th/7th style preview)</option>
          <option value="mla">MLA (8th/9th style preview)</option>
        </select>

        <select id="pageMargins">
          <option value="normal">Normal margins (1 inch)</option>
          <option value="narrow">Narrow margins (0.5 inch)</option>
        </select>

        <select id="lineSpacing">
          <option value="1.0">Single</option>
          <option value="1.5" selected>1.5</option>
          <option value="2.0">Double</option>
        </select>

        <button id="saveDraftBtn" class="btn">Save Draft</button>
        <button id="submitBtn" class="btn">Submit Assignment</button>
        <button id="exportPdfBtn" class="btn">Export PDF{% if user_plan_info.is_watermarked_export %} (Watermarked){% endif %}</button>
        <button id="exportDocxBtn" class="btn">Export Word{% if user_plan_info.is_watermarked_export %} (Watermarked){% endif %}</button>
      </div>
      <div id="feedbackMessage" style="margin-top: 10px; padding: 8px; border-radius: 6px; font-size: 0.9em; min-height: 20px;"></div>
    </div>

    <!-- Right Side: Live Preview -->
    <div class="preview-pane">
      <h3 style="margin:8px 0">Live Preview</h3>
      <div class="preview-wrapper">
        <div id="page" class="page margin-normal">
          <div id="pageContent" class="content">
            <!-- Quill HTML will be injected here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    // Initialize Quill Editor
    var quill = new Quill('#editor', { theme: 'snow', modules: { toolbar: '#toolbar' } });

    // Live preview update
    function updatePreview(){
      const html = quill.root.innerHTML;
      document.getElementById('pageContent').innerHTML = html;
    }
    quill.on('text-change', updatePreview);

    // Controls
    document.getElementById('citationStyle').addEventListener('change', (e) => {
      const style = e.target.value;
      applyCitationStyle(style);
    });

    document.getElementById('pageMargins').addEventListener('change', (e) => {
      const page = document.getElementById('page');
      if (e.target.value === 'narrow') {
        page.classList.remove('margin-normal');
        page.classList.add('margin-narrow');
      } else {
        page.classList.remove('margin-narrow');
        page.classList.add('margin-normal');
      }
    });

    document.getElementById('lineSpacing').addEventListener('change', (e) => {
      const spacing = e.target.value;
      document.querySelector('#page .content').style.lineHeight = spacing;
    });

    // Citation style functions (visual adjustments only)
    function applyCitationStyle(style) {
      const page = document.getElementById('page');
      const content = document.getElementById('pageContent');

      // reset
      page.style.fontFamily = '"Times New Roman", serif';
      page.style.fontSize = '12pt';
      page.style.padding = '1in';
      content.style.lineHeight = '1.5';
      content.style.fontSize = '12pt';
      content.style.textAlign = 'left';

      if (style === 'apa') {
        // APA: double spaced (often), title page conventions â€” here we simulate body style
        content.style.lineHeight = '2.0';
        // additional visual hints: indented paragraphs for references (we will format references later)
      } else if (style === 'mla') {
        // MLA: double spaced with first-line indent; smaller margins sometimes same as APA
        content.style.lineHeight = '2.0';
        // we can visually set first-line indent via CSS for paragraphs
        const css = `.page .content p { text-indent: 0.5in; margin: 0 0 0.5em 0; }`;
        applyTemporaryCSS(css, 'mla-indent');
      } else {
        removeTemporaryCSS('mla-indent');
      }
    }

    // helper: inject temporary CSS for MLA indents
    function applyTemporaryCSS(cssText, id) {
      removeTemporaryCSS(id);
      const style = document.createElement('style');
      style.id = id;
      style.innerHTML = cssText;
      document.head.appendChild(style);
    }
    function removeTemporaryCSS(id) {
      const existing = document.getElementById(id);
      if (existing) existing.remove();
    }

    // Save Draft (example local)
    // function saveDraft() {
    //   const content = quill.root.innerHTML;
    //   localStorage.setItem('assignmentDraft', content);
    //   alert("Draft saved locally!");
    // }

    async function saveDraftToServer() {
      showFeedback('Saving draft...', 'info');
      const content = quill.root.innerHTML;
      const title = (quill.getText().trim().split('\n')[0] || 'Untitled').slice(0,250);
      const payload = { content, title, document_id: window.currentDocId || null };
      try {
        const res = await fetch('/api/save_draft', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (j.ok) {
          window.currentDocId = j.document_id;
          showFeedback('Draft saved successfully!', 'success');
          // Update URL to reflect the document_id, allowing direct access/refresh
          const newUrl = new URL(window.location.href);
          newUrl.searchParams.set('doc_id', j.document_id);
          window.history.pushState({ path: newUrl.href }, '', newUrl.href);
        } else {
          showFeedback('Save failed: ' + (j.error || 'unknown'), 'error');
        }
      } catch (e) {
        showFeedback('Error saving draft: ' + e.message, 'error');
      }
    }

    async function submitAssignmentToServer() {
      if (!window.currentDocId) {
        showFeedback('Please save your draft first before submitting.', 'error');
        return; // Prevent submission if not saved
      }
      showFeedback('Submitting assignment...', 'info');
      try {
        const res = await fetch('/api/submit_assignment', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ document_id: window.currentDocId })
        });
        const j = await res.json();
        if (j.ok) {
          showFeedback('Assignment submitted! ID: ' + j.document_id, 'success');
        } else {
          showFeedback('Submit failed: ' + (j.error || 'unknown'), 'error');
        }
      } catch (e) {
        showFeedback('Error submitting assignment: ' + e.message, 'error');
      }
    }

    // Hook up buttons
    document.getElementById('saveDraftBtn').addEventListener('click', saveDraftToServer);
    document.getElementById('submitBtn').addEventListener('click', submitAssignmentToServer);
    document.getElementById('exportPdfBtn').addEventListener('click', () => {
      if (!window.currentDocId) { showFeedback('Save first before exporting!', 'error'); return; }
      // Open in new tab to allow download and not interfere with current page
      window.open(`/export/${window.currentDocId}?type=pdf`, '_blank');
      showFeedback('PDF export initiated.', 'info');
    });
    document.getElementById('exportDocxBtn').addEventListener('click', () => {
      if (!window.currentDocId) { showFeedback('Save first before exporting!', 'error'); return; }
      // Open in new tab to allow download and not interfere with current page
      window.open(`/export/${window.currentDocId}?type=docx`, '_blank');
      showFeedback('Word export initiated.', 'info');
    });

    // init preview
    updatePreview();

    // Load existing document if doc_id is in URL
    async function loadDocument(docId) {
      try {
        const res = await fetch(`/api/doc/${docId}`);
        const data = await res.json();
        if (data.ok && data.document) {
          quill.root.innerHTML = data.document.content || '';
          window.currentDocId = docId;
          updatePreview();
          showFeedback('Document loaded.', 'success');
        } else {
          showFeedback('Failed to load document: ' + (data.error || 'unknown'), 'error');
        }
      } catch (e) {
        showFeedback('Error loading document: ' + e.message, 'error');
      }
    }

    // Check URL for doc_id on load
    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('doc_id');
    if (docId) {
      loadDocument(docId);
    } else {
      // If no doc_id, clear the editor for a new document
      quill.root.innerHTML = '';
      window.currentDocId = null;
      updatePreview();
    }

    // Helper function to display feedback messages
    function showFeedback(message, type = 'info') {
      const feedbackEl = document.getElementById('feedbackMessage');
      feedbackEl.textContent = message;
      feedbackEl.style.backgroundColor = '';
      feedbackEl.style.color = '';
      feedbackEl.style.border = '';

      if (type === 'success') {
        feedbackEl.style.backgroundColor = '#e6ffed';
        feedbackEl.style.color = '#1b5e20';
        feedbackEl.style.border = '1px solid #a7d9b5';
      } else if (type === 'error') {
        feedbackEl.style.backgroundColor = '#ffebee';
        feedbackEl.style.color = '#c62828';
        feedbackEl.style.border = '1px solid #ef9a9a';
      } else if (type === 'info') {
        feedbackEl.style.backgroundColor = '#e3f2fd';
        feedbackEl.style.color = '#1565c0';
        feedbackEl.style.border = '1px solid #90caf9';
      }
      setTimeout(() => feedbackEl.textContent = '', 5000);
    }
  </script>
</body>
</html>
