<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Assignment Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-r from-[#1E293B] to-[#0F172A] text-white font-sans">

  <!-- Container -->
  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="max-w-2xl w-full bg-[#1E293B] rounded-2xl shadow-lg p-8">
      
      <!-- Title -->
      <h1 class="text-3xl font-bold text-center mb-6">Checkout</h1>

      <!-- Order Summary -->
      <div class="bg-[#0F172A] rounded-xl p-6 mb-6 shadow-md">
        <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
          <i class="bx bx-receipt text-blue-400"></i> Order Summary
        </h2>
        {% if selected_plan %}
        <p class="text-gray-300">Plan: <span id="planName" class="font-bold text-white">{{ selected_plan.name }}</span></p>
        <p class="text-gray-300">Price:
            <span id="planPrice" class="font-bold text-green-400">
                {% if selected_plan.plan_type == 'free' %}
                Free
                {% elif selected_plan.plan_type == 'one_time_document' %}
                {{ selected_plan.currency }} {{ "%.2f"|format(selected_plan.document_cost) }} / document
                {% else %}
                {{ selected_plan.currency }} {{ "%.2f"|format(selected_plan.price) }} / month
                {% endif %}
            </span>
        </p>
        <ul class="mt-2 text-gray-400 text-sm list-disc list-inside">
            {% for feature in selected_plan.features %}
            <li>{{ feature }}</li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-300">No plan selected. Please go back to choose a plan.</p>
        {% endif %}
      </div>

      <!-- Payment Method -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
          <i class="bx bx-credit-card text-blue-400"></i> Payment Method
        </h2>
        <div class="space-y-3">
          <label class="flex items-center gap-3 bg-[#0F172A] p-3 rounded-lg cursor-pointer hover:bg-blue-900">
            <input type="radio" name="payment" class="form-radio text-blue-500" checked>
            <i class="bx bx-credit-card text-xl"></i> Credit/Debit Card
          </label>
          <label class="flex items-center gap-3 bg-[#0F172A] p-3 rounded-lg cursor-pointer hover:bg-blue-900">
            <input type="radio" name="payment" class="form-radio text-blue-500">
            <i class="bx bxl-paypal text-xl text-blue-400"></i> PayPal
          </label>
          <label class="flex items-center gap-3 bg-[#0F172A] p-3 rounded-lg cursor-pointer hover:bg-blue-900">
            <input type="radio" name="payment" class="form-radio text-blue-500">
            <i class="bx bx-mobile text-xl text-green-400"></i> M-Pesa / Mobile Money
          </label>
        </div>
      </div>

      <!-- User Info -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
          <i class="bx bx-user text-blue-400"></i> Contact Info
        </h2>
        <input type="email" placeholder="Enter your email" class="w-full p-3 rounded-lg text-black focus:ring-2 focus:ring-blue-500 mb-3">
        <input type="text" placeholder="Phone number (optional)" class="w-full p-3 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Pay Button -->
      <button id="payNowBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-700 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-800 transition">
        Pay Now
      </button>
      <div id="paymentFeedback" class="mt-4 text-center text-sm font-medium"></div>

      <!-- Back link -->
      <p class="mt-4 text-center text-gray-400 text-sm">
        <a href="{{ url_for('plans') }}" class="text-blue-400 hover:underline">← Back to Plans</a>
      </p>

    </div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const payNowBtn = document.getElementById('payNowBtn');
        const paymentFeedback = document.getElementById('paymentFeedback');

        const urlParams = new URLSearchParams(window.location.search);
        const planId = urlParams.get('plan_id');

        payNowBtn.addEventListener('click', async () => {
            if (!planId) {
                paymentFeedback.innerHTML = '<span class="text-red-500">Error: No plan selected.</span>';
                return;
            }

            paymentFeedback.innerHTML = '<span class="text-blue-400">Processing payment...</span>';
            payNowBtn.disabled = true;

            try {
                const response = await fetch('/api/initiate_payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ plan_id: parseInt(planId), quantity: 1 }) // Quantity can be dynamic for pay-per-doc
                });

                const data = await response.json();

                if (data.ok) {
                    paymentFeedback.innerHTML = '<span class="text-green-500">✅ Payment successful! Redirecting...</span>';
                    // Optionally redirect to dashboard or a success page after a short delay
                    setTimeout(() => { window.location.href = '{{ url_for('dashboard') }}'; }, 2000);
                } else {
                    paymentFeedback.innerHTML = `<span class="text-red-500">Error: ${data.error || 'Payment failed.'}</span>`;
                }
            } catch (error) {
                console.error('Error initiating payment:', error);
                paymentFeedback.innerHTML = '<span class="text-red-500">An unexpected error occurred.</span>';
            } finally {
                payNowBtn.disabled = false;
            }
        });
    });
</script>
</body>
</html>
